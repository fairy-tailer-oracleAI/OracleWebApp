<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Колесо Фортуны</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: Arial, sans-serif; height: 100vh;
            overflow: hidden; background: #1a1a1a;
            display: flex; flex-direction: column;
        }
        .top-section { height: 50vh; width: 100%; position: relative; }
        .wheel-container {
            width: 100%; height: 100%; position: relative;
            overflow: hidden; display: flex; justify-content: center;
        }
        .wheel {
            width: 100vh; height: 100vh; min-width: 100vh;
            border-radius: 50%; position: absolute; top: -50vh;
            background: conic-gradient(
                #ff4444 0deg 60deg, #44ff44 60deg 120deg,
                #4444ff 120deg 180deg, #ffff44 180deg 240deg,
                #ff44ff 240deg 300deg, #44ffff 300deg 360deg
            );
            box-shadow: 0 0 0 4px rgba(255, 255, 255, 0.3), inset 0 0 50px rgba(0, 0, 0, 0.5);
            will-change: transform;
        }

        .wheel-pointer {
            position: absolute; top: 50vh; left: 50%;
            width: 45px; height: 55px;
            transform: translate(-50%, -85%) rotate(0deg);
            background: linear-gradient(135deg, #ffeb3b, #fbc02d);
            border-radius: 50% 50% 35% 35% / 70% 70% 30% 30%;
            border: 3px solid #ffffff;
            box-shadow: 0 4px 10px rgba(0,0,0,0.4);
            z-index: 100; transform-origin: 50% 100%;
            /* Плавный возврат из JS-отклонения */
            transition: transform 0.15s cubic-bezier(0.17, 0.67, 0.83, 0.67);
            will-change: transform;
        }

        /* Анимация жесткого дребезжания для быстрого вращения */
        @keyframes rattle {
            0% { transform: translate(-50%, -85%) rotate(0deg); }
            50% { transform: translate(-50%, -85%) rotate(15deg); }
            100% { transform: translate(-50%, -85%) rotate(0deg); }
        }
        .rattling {
            animation: rattle 0.1s infinite linear;
            transition: none !important;
        }

        .button-container { height: 50vh; display: flex; justify-content: center; align-items: center; }
        .spin-button {
            padding: 20px 70px; font-size: 26px; font-weight: bold;
            background: linear-gradient(135deg, #ff3366, #ff0066);
            color: white; border: none; border-radius: 50px;
            cursor: pointer; box-shadow: 0 5px 15px rgba(255, 51, 102, 0.4);
            -webkit-tap-highlight-color: transparent;
        }
        .spin-button:disabled { opacity: 0.5; }
    </style>
</head>
<body>
    <div class="top-section">
        <div class="wheel-container"><div class="wheel" id="fortuneWheel"></div></div>
        <div class="wheel-pointer" id="pointer"></div>
    </div>
    <div class="button-container"><button class="spin-button" id="spinButton">КРУТИТЬ</button></div>

    <script>
        const CONFIG = {
            numSectors: 6,
            spinDuration: 8000,
            minSpins: 7,
            idleSpeed: -0.015,
            hitZone: 12,
            deflection: 4
        };

        let currentRotation = 0;
        let isSpinning = false;
        let lastFrameTime = performance.now();
        let idleMode = true;

        const el = {
            wheel: document.getElementById('fortuneWheel'),
            pointer: document.getElementById('pointer'),
            btn: document.getElementById('spinButton')
        };

        function updatePointer(rotation, speed = 0) {
            el.wheel.style.transform = `rotate(${rotation}deg)`;

            // Если скорость высокая (спин), включаем CSS-анимацию дребезжания
            if (speed > 0.5) {
                el.pointer.classList.add('rattling');
                return;
            }

            el.pointer.classList.remove('rattling');

            // Логика для медленного вращения (idle или конец спина)
            const sectorAngle = 360 / CONFIG.numSectors;
            const normalized = ((rotation % sectorAngle) + sectorAngle) % sectorAngle;

            if (normalized > (sectorAngle - CONFIG.hitZone)) {
                const p = (normalized - (sectorAngle - CONFIG.hitZone)) / CONFIG.hitZone;
                el.pointer.style.transform = `translate(-50%, -85%) rotate(${p * 15}deg)`;
            } else {
                el.pointer.style.transform = `translate(-50%, -85%) rotate(0deg)`;
            }
        }

        function animate(now) {
            const dt = now - lastFrameTime;
            lastFrameTime = now;
            if (idleMode && !isSpinning) {
                currentRotation += CONFIG.idleSpeed * dt;
                updatePointer(currentRotation, 0);
            }
            requestAnimationFrame(animate);
        }

        function spin() {
            if (isSpinning) return;
            isSpinning = true; idleMode = false;
            el.btn.disabled = true;

            const startRot = currentRotation;
            const targetRot = (CONFIG.minSpins * 360) + Math.random() * 360;
            const startTime = performance.now();
            const easeOut = t => 1 - Math.pow(1 - t, 4);

            function step(now) {
                const elapsed = now - startTime;
                const progress = Math.min(elapsed / CONFIG.spinDuration, 1);

                // Текущая скорость для определения "дребезжания"
                const speed = (1 - progress);

                currentRotation = startRot + (targetRot * easeOut(progress));
                updatePointer(currentRotation, speed);

                if (progress < 1) {
                    requestAnimationFrame(step);
                } else {
                    isSpinning = false;
                    el.btn.disabled = false;
                    el.pointer.classList.remove('rattling');
                    setTimeout(() => { if(!isSpinning) idleMode = true; }, 2000);
                }
            }
            requestAnimationFrame(step);
        }

        el.btn.addEventListener('click', spin);
        requestAnimationFrame(animate);
    </script>
</body>
</html>